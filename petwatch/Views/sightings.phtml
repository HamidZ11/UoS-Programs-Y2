<?php require('template/header.phtml'); ?>

    <div class="container py-5">
        <h2 class="text-center mb-4">All Sightings</h2>

        <!-- Sort Controls -->
        <form method="GET" class="text-center mb-4">
            <input type="hidden" name="page" value="sightings">
            <label for="sort" class="me-2 fw-semibold">Sort by:</label>
            <select name="sort" id="sort" class="form-select d-inline-block w-auto">
                <option value="dateReported DESC" <?= ($_GET['sort'] ?? '') === 'dateReported DESC' ? 'selected' : '' ?>>Newest First</option>
                <option value="dateReported ASC" <?= ($_GET['sort'] ?? '') === 'dateReported ASC' ? 'selected' : '' ?>>Oldest First</option>
                <option value="petName ASC" <?= ($_GET['sort'] ?? '') === 'petName ASC' ? 'selected' : '' ?>>Pet Name (A‚ÄìZ)</option>
                <option value="petName DESC" <?= ($_GET['sort'] ?? '') === 'petName DESC' ? 'selected' : '' ?>>Pet Name (Z‚ÄìA)</option>
            </select>
            <button type="submit" class="btn btn-primary btn-sm ms-2">Sort</button>
        </form>

        <div class="card shadow-sm">
            <div class="card-body">
                <?php if (!empty($view->sightingsDataSet)): ?>

                    <!-- DESKTOP TABLE VIEW -->
                    <div class="table-responsive d-none d-md-block">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle">
                                <thead class="table-dark">
                                <tr>
                                    <th style="width: 7%;">Sighting ID</th>
                                    <th style="width: 10%;">Pet Name</th>
                                    <th style="width: 8%;">Pet ID</th>
                                    <th style="width: 25%;">Description</th>
                                    <th style="width: 12%;">Latitude</th>
                                    <th style="width: 12%;">Longitude</th>
                                    <th style="width: 13%;">Date Reported</th>
                                    <th style="width: 8%;">Reported By</th>
                                    <th style="width: 5%;">Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                <?php foreach ($view->sightingsDataSet as $sighting): ?>
                                    <tr>
                                        <td><?= htmlspecialchars($sighting['sightingID']) ?></td>
                                        <td><?= htmlspecialchars($sighting['petName'] ?? '‚Äî') ?></td>
                                        <td><?= htmlspecialchars($sighting['petID'] ?? '‚Äî') ?></td>
                                        <td style="white-space: normal; word-wrap: break-word; overflow-wrap: break-word;">
                                            <?= htmlspecialchars($sighting['description']) ?>
                                        </td>
                                        <td><?= isset($sighting['latitude']) ? round($sighting['latitude'], 5) : '‚Äî' ?></td>
                                        <td><?= isset($sighting['longitude']) ? round($sighting['longitude'], 5) : '‚Äî' ?></td>
                                        <td><?= htmlspecialchars($sighting['dateReported']) ?></td>
                                        <td><?= htmlspecialchars($sighting['reporterName'] ?? 'Unknown') ?></td>
                                        <td style="white-space: nowrap;">
                                            <?php if (isset($_SESSION['user']) && $_SESSION['user']['userID'] == $sighting['userID']): ?>
                                                <a href="index.php?page=editSighting&sightingID=<?= urlencode($sighting['sightingID']) ?>"
                                                   class="btn btn-sm btn-outline-warning mb-1">Edit</a>
                                                <a href="index.php?page=deleteSighting&sightingID=<?= urlencode($sighting['sightingID']) ?>"
                                                   class="btn btn-sm btn-outline-danger mb-1"
                                                   onclick="return confirm('Delete this sighting?');">Delete</a>
                                            <?php else: ?>
                                                ‚Äî
                                            <?php endif; ?>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- MOBILE CARD VIEW -->
                    <div class="d-block d-md-none mt-4">
                        <?php foreach ($view->sightingsDataSet as $sighting): ?>
                            <div class="card mb-3 shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title mb-1">üêæ <?= htmlspecialchars($sighting['petName'] ?? 'Unknown Pet') ?></h5>
                                    <small class="text-muted">
                                        Sighting ID #<?= htmlspecialchars($sighting['sightingID']) ?> ‚Ä¢
                                        Pet ID #<?= htmlspecialchars($sighting['petID'] ?? '‚Äî') ?>
                                    </small>

                                    <p class="card-text mt-3 mb-1"><strong>Description:</strong> <?= htmlspecialchars($sighting['description']) ?></p>

                                    <div class="text-muted small mb-3">
                                        <div><strong>Latitude:</strong> <?= htmlspecialchars($sighting['latitude'] ?? '‚Äî') ?></div>
                                        <div><strong>Longitude:</strong> <?= htmlspecialchars($sighting['longitude'] ?? '‚Äî') ?></div>
                                        <div><strong>Date Reported:</strong> <?= htmlspecialchars($sighting['dateReported']) ?></div>
                                        <div><strong>Reported By:</strong> <?= htmlspecialchars($sighting['reporterName'] ?? 'Unknown') ?></div>
                                    </div>

                                    <div class="d-flex flex-wrap gap-2">
                                        <?php if (isset($_SESSION['user']) && $_SESSION['user']['userID'] == $sighting['userID']): ?>
                                            <a href="index.php?page=editSighting&sightingID=<?= urlencode($sighting['sightingID']) ?>"
                                               class="btn btn-sm btn-outline-warning">Edit</a>
                                            <a href="index.php?page=deleteSighting&sightingID=<?= urlencode($sighting['sightingID']) ?>"
                                               class="btn btn-sm btn-outline-danger"
                                               onclick="return confirm('Delete this sighting?');">Delete</a>
                                        <?php else: ?>
                                            <span class="text-muted small">View only</span>
                                        <?php endif; ?>
                                    </div>
                                </div>
                            </div>
                        <?php endforeach; ?>
                    </div>

                <?php else: ?>
                    <p class="text-center text-muted mb-0">No sightings recorded yet.</p>
                <?php endif; ?>
            </div>
        </div>
    </div>

<?php require('template/footer.phtml'); ?>